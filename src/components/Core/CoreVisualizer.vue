
<script>
import { Object3D, MathUtils, MeshBasicMaterial, Mesh, BoxGeometry, MeshStandardMaterial, LoadingManager, TextureLoader, PointLight } from 'three';
import {Camera, EffectComposer, InstancedMesh, PhongMaterial, Renderer, RenderPass, SphereGeometry, SpotLight, Scene, UnrealBloomPass, AmbientLight} from 'troisjs';
import { OBJLoader } from 'three/examples/jsm/loaders/OBJLoader.js';
import { useCoreStore } from '/src/stores/core'
import * as Utils from '/src/assets/js/utils.js'

export default {
    components: {
        Camera,
        EffectComposer,
        InstancedMesh,
        PhongMaterial,
        Renderer,
        RenderPass,
        SphereGeometry,
        SpotLight,
        Scene,
        AmbientLight,
    },
    data() {
        const coreStore = useCoreStore();
        const current3dObject = null
        return {
            coreStore,
            current3dObject,
        }
    },
    methods: {
        removeObject3D(object3D) {
            if (!(object3D instanceof Object3D)) return false;

            // for better memory management and performance
            if (object3D.geometry) object3D.geometry.dispose();

            if (object3D.material) {
                if (object3D.material instanceof Array) {
                    // for better memory management and performance
                    object3D.material.forEach(material => material.dispose());
                } else {
                    // for better memory management and performance
                    object3D.material.dispose();
                }
            }
            object3D.removeFromParent(); // the parent might be the scene or another Object3D, but it is sure to be removed this way
            return true;
        },
        getPiece(sourceObject) {            
            const scene = this.$refs.scene.scene;
            this.removeObject3D(this.current3dObject)

            const ea = `# FreeCAD v0.21 build Arch module
                        # http://www.freecadweb.org
                        mtllib ER_28_17_11_piece.mtl
                        o Refine
                        v 5.7 14.25 0.0
                        v -5.7 14.25 0.0
                        v -5.7 14.25 16.9
                        v 5.7 14.25 16.9
                        v -5.7 -9.232145 4.4
                        v -5.7 -14.25 0.0
                        v -5.7 -14.25 16.9
                        v -5.7 -9.232145 16.9
                        v -5.7 9.232145 4.4
                        v -5.7 9.232145 16.9
                        v 5.7 9.232145 4.4
                        v 5.7 9.232145 16.9
                        v 5.7 -9.232145 4.4
                        v 5.7 -9.232145 16.9
                        v 5.7 -14.25 16.9
                        v 5.7 -14.25 0.0
                        v -3.910854 10.120658 16.9
                        v -1.989141 10.666106 16.9
                        v 0.0 10.85 16.9
                        v 3.910854 10.120658 16.9
                        v 1.989141 10.666106 16.9
                        v 4.286826 -2.475 4.4
                        v 3.181799 -3.79192 4.4
                        v 1.693 -4.651478 4.4
                        v 2.962577 -10.437702 4.4
                        v 4.874798 -0.859558 4.4
                        v -0.0 -4.95 4.4
                        v -2.962577 -10.437702 4.4
                        v -0.0 -10.85 4.4
                        v 4.874798 0.859558 4.4
                        v -1.693 -4.651478 4.4
                        v -3.181799 -3.79192 4.4
                        v -4.286826 -2.475 4.4
                        v 4.286826 2.475 4.4
                        v 3.181799 3.79192 4.4
                        v 1.693 4.651478 4.4
                        v -4.874798 -0.859558 4.4
                        v 3.910854 10.120658 4.4
                        v 1.989141 10.666106 4.4
                        v 0.0 4.95 4.4
                        v 0.0 10.85 4.4
                        v -1.989141 10.666106 4.4
                        v -1.693 4.651478 4.4
                        v -3.910854 10.120658 4.4
                        v -3.181799 3.79192 4.4
                        v -4.286826 2.475 4.4
                        v -4.874798 0.859558 4.4
                        v -2.962577 -10.437702 16.9
                        v -0.0 -10.85 16.9
                        v 2.962577 -10.437702 16.9
                        v -1.693 4.651478 16.9
                        v 0.0 4.95 16.9
                        v -3.181799 3.79192 16.9
                        v -4.286826 2.475 16.9
                        v -4.874798 0.859558 16.9
                        v -4.874798 -0.859558 16.9
                        v -4.286826 -2.475 16.9
                        v -3.181799 -3.79192 16.9
                        v -1.693 -4.651478 16.9
                        v -0.0 -4.95 16.9
                        v 1.693 -4.651478 16.9
                        v 3.181799 -3.79192 16.9
                        v 4.286826 -2.475 16.9
                        v 4.874798 -0.859558 16.9
                        v 4.874798 0.859558 16.9
                        v 4.286826 2.475 16.9
                        v 3.181799 3.79192 16.9
                        v 1.693 4.651478 16.9
                        vn 0.0 1.0 0.0
                        vn 0.0 1.0 -0.0
                        vn -1.0 -0.0 0.0
                        vn -1.0 0.0 0.0
                        vn -1.0 0.0 0.0
                        vn -1.0 0.0 0.0
                        vn -1.0 0.0 0.0
                        vn -1.0 0.0 0.0
                        vn 1.0 -0.0 0.0
                        vn 1.0 0.0 0.0
                        vn 1.0 0.0 -0.0
                        vn 1.0 0.0 0.0
                        vn 1.0 0.0 0.0
                        vn 1.0 0.0 0.0
                        vn 0.0 0.0 -1.0
                        vn 0.0 0.0 -1.0
                        vn 0.0 0.0 1.0
                        vn 0.0 0.0 1.0
                        vn 0.0 0.0 1.0
                        vn 0.0 0.0 1.0
                        vn 0.0 0.0 1.0
                        vn 0.0 0.0 1.0
                        vn 0.0 0.0 1.0
                        vn 0.0 0.0 1.0
                        vn 0.0 0.0 1.0
                        vn -0.0 0.0 1.0
                        vn 0.0 0.0 1.0
                        vn 0.0 0.0 1.0
                        vn 0.0 0.0 1.0
                        vn -0.0 0.0 1.0
                        vn 0.0 0.0 1.0
                        vn 0.0 0.0 1.0
                        vn 0.0 0.0 1.0
                        vn 0.0 0.0 1.0
                        vn 0.0 0.0 1.0
                        vn 0.0 0.0 1.0
                        vn 0.0 0.0 1.0
                        vn 0.0 0.0 1.0
                        vn 0.0 0.0 1.0
                        vn 0.0 0.0 1.0
                        vn 0.0 0.0 1.0
                        vn 0.0 0.0 1.0
                        vn 0.0 0.0 1.0
                        vn 0.0 0.0 1.0
                        vn 0.0 0.0 1.0
                        vn -0.0 0.0 1.0
                        vn -0.0 0.0 1.0
                        vn 0.0 0.0 1.0
                        vn 0.0 0.0 1.0
                        vn 0.0 0.0 1.0
                        vn -0.0 0.0 1.0
                        vn 0.0 0.0 1.0
                        vn 0.0 0.0 1.0
                        vn 0.4030441641807556 0.9151805639266968 -0.0
                        vn 0.13784031569957733 0.9904544353485107 -0.0
                        vn 0.4030441641807556 0.9151805639266968 0.0
                        vn 0.13784031569957733 0.9904544353485107 0.0
                        vn -0.13784031569957733 0.9904544353485107 0.0
                        vn -0.13784031569957733 0.9904544353485107 0.0
                        vn -0.4030441641807556 0.9151805639266968 0.0
                        vn -0.4030441641807556 0.9151805639266968 0.0
                        vn 0.0 0.0 1.0
                        vn 0.0 0.0 1.0
                        vn 0.0 0.0 1.0
                        vn 0.0 0.0 1.0
                        vn 0.0 0.0 1.0
                        vn 0.0 -1.0 0.0
                        vn 0.0 -1.0 0.0
                        vn -0.1736481785774231 0.9848077297210693 0.0
                        vn -0.1736481785774231 0.9848077297210693 0.0
                        vn -0.4999999701976776 0.8660255074501038 0.0
                        vn -0.4999999701976776 0.8660255074501038 0.0
                        vn -0.7660444974899292 0.6427875757217407 0.0
                        vn -0.9396926760673523 0.342020183801651 0.0
                        vn -0.7660444974899292 0.6427875757217407 0.0
                        vn -0.9396926760673523 0.342020183801651 0.0
                        vn -1.0 0.0 0.0
                        vn -1.0 0.0 0.0
                        vn -0.9396926760673523 -0.342020183801651 -0.0
                        vn -0.9396926760673523 -0.342020183801651 0.0
                        vn -0.7660444974899292 -0.6427875757217407 -0.0
                        vn -0.7660444974899292 -0.6427875757217407 0.0
                        vn -0.4999999701976776 -0.8660255074501038 -0.0
                        vn -0.1736481785774231 -0.9848077297210693 -0.0
                        vn -0.4999999701976776 -0.8660255074501038 0.0
                        vn -0.1736481785774231 -0.9848077297210693 -0.0
                        vn 0.1736481785774231 -0.9848077297210693 0.0
                        vn 0.1736481785774231 -0.9848077297210693 0.0
                        vn 0.4999999701976776 -0.8660255074501038 0.0
                        vn 0.4999999701976776 -0.8660255074501038 0.0
                        vn 0.7660444974899292 -0.6427875757217407 0.0
                        vn 0.7660444974899292 -0.6427875757217407 0.0
                        vn 0.9396926760673523 -0.342020183801651 0.0
                        vn 1.0 0.0 0.0
                        vn 0.9396926760673523 -0.342020183801651 0.0
                        vn 1.0 0.0 0.0
                        vn 0.9396926760673523 0.342020183801651 0.0
                        vn 0.9396926760673523 0.342020183801651 0.0
                        vn 0.7660444974899292 0.6427875757217407 0.0
                        vn 0.7660444974899292 0.6427875757217407 0.0
                        vn 0.4999999701976776 0.8660255074501038 0.0
                        vn 0.4999999701976776 0.8660255074501038 0.0
                        vn 0.1736481785774231 0.9848077297210693 0.0
                        vn 0.1736481785774231 0.9848077297210693 0.0
                        vn 0.0 0.0 1.0
                        vn 0.0 0.0 1.0
                        vn 0.0 0.0 1.0
                        vn 0.0 0.0 1.0
                        vn 0.0 0.0 1.0
                        vn 0.0 0.0 1.0
                        vn 0.0 0.0 1.0
                        vn 0.0 0.0 1.0
                        vn 0.0 0.0 1.0
                        vn 0.0 0.0 1.0
                        vn 0.0 0.0 1.0
                        vn 0.0 0.0 1.0
                        vn 0.0 0.0 1.0
                        vn 0.0 0.0 1.0
                        vn 0.0 0.0 1.0
                        vn 0.0 0.0 1.0
                        vn -0.4447849988937378 -0.8956373333930969 -0.0
                        vn -0.4447849988937378 -0.8956373333930969 0.0
                        vn -0.2730486989021301 -0.9620002508163452 0.0
                        vn -0.2730486989021301 -0.9620002508163452 -0.0
                        vn -0.09205649048089981 -0.9957537651062012 0.0
                        vn 0.09205649048089981 -0.9957537651062012 0.0
                        vn -0.09205649048089981 -0.9957537651062012 -0.0
                        vn 0.2730486989021301 -0.9620002508163452 0.0
                        vn 0.09205649048089981 -0.9957537651062012 0.0
                        vn 0.4447849988937378 -0.8956373333930969 0.0
                        vn 0.2730486989021301 -0.9620002508163452 0.0
                        vn 0.4447849988937378 -0.8956373333930969 0.0
                        f 1//1 2//1 3//1 
                        f 1//2 3//2 4//2 
                        f 5//3 6//3 7//3 
                        f 5//4 7//4 8//4 
                        f 9//5 10//5 3//5 
                        f 2//6 9//6 3//6 
                        f 2//7 6//7 5//7 
                        f 2//8 5//8 9//8 
                        f 11//9 1//9 4//9 
                        f 11//10 4//10 12//10 
                        f 13//11 14//11 15//11 
                        f 16//12 13//12 15//12 
                        f 16//13 1//13 11//13 
                        f 16//14 11//14 13//14 
                        f 2//15 1//15 6//15 
                        f 6//16 1//16 16//16 
                        f 3//17 10//17 17//17 
                        f 18//18 3//18 17//18 
                        f 19//19 3//19 18//19 
                        f 4//20 20//20 12//20 
                        f 4//21 21//21 20//21 
                        f 4//22 19//22 21//22 
                        f 4//23 3//23 19//23 
                        f 22//24 23//24 13//24 
                        f 24//25 25//25 13//25 
                        f 24//26 13//26 23//26 
                        f 26//27 22//27 13//27 
                        f 27//28 28//28 29//28 
                        f 27//29 29//29 25//29 
                        f 27//30 25//30 24//30 
                        f 30//31 26//31 13//31 
                        f 31//32 5//32 28//32 
                        f 31//33 28//33 27//33 
                        f 32//34 5//34 31//34 
                        f 33//35 5//35 32//35 
                        f 11//36 34//36 30//36 
                        f 11//37 35//37 34//37 
                        f 11//38 36//38 35//38 
                        f 11//39 30//39 13//39 
                        f 37//40 5//40 33//40 
                        f 38//41 36//41 11//41 
                        f 39//42 40//42 36//42 
                        f 39//43 36//43 38//43 
                        f 41//44 40//44 39//44 
                        f 42//45 43//45 40//45 
                        f 42//46 40//46 41//46 
                        f 44//47 43//47 42//47 
                        f 9//48 45//48 43//48 
                        f 9//49 46//49 45//49 
                        f 9//50 47//50 46//50 
                        f 9//51 43//51 44//51 
                        f 9//52 5//52 37//52 
                        f 9//53 37//53 47//53 
                        f 5//54 8//54 28//54 
                        f 28//55 48//55 29//55 
                        f 8//56 48//56 28//56 
                        f 48//57 49//57 29//57 
                        f 29//58 50//58 25//58 
                        f 49//59 50//59 29//59 
                        f 25//60 14//60 13//60 
                        f 50//61 14//61 25//61 
                        f 48//62 8//62 7//62 
                        f 49//63 48//63 7//63 
                        f 15//64 49//64 7//64 
                        f 50//65 49//65 15//65 
                        f 14//66 50//66 15//66 
                        f 6//67 16//67 15//67 
                        f 6//68 15//68 7//68 
                        f 51//69 52//69 40//69 
                        f 51//70 40//70 43//70 
                        f 53//71 43//71 45//71 
                        f 53//72 51//72 43//72 
                        f 54//73 45//73 46//73 
                        f 54//74 46//74 47//74 
                        f 54//75 53//75 45//75 
                        f 55//76 54//76 47//76 
                        f 56//77 47//77 37//77 
                        f 56//78 55//78 47//78 
                        f 57//79 37//79 33//79 
                        f 57//80 56//80 37//80 
                        f 58//81 33//81 32//81 
                        f 58//82 57//82 33//82 
                        f 59//83 32//83 31//83 
                        f 59//84 31//84 27//84 
                        f 59//85 58//85 32//85 
                        f 60//86 59//86 27//86 
                        f 61//87 27//87 24//87 
                        f 61//88 60//88 27//88 
                        f 62//89 24//89 23//89 
                        f 62//90 61//90 24//90 
                        f 63//91 23//91 22//91 
                        f 63//92 62//92 23//92 
                        f 64//93 22//93 26//93 
                        f 64//94 26//94 30//94 
                        f 64//95 63//95 22//95 
                        f 65//96 64//96 30//96 
                        f 66//97 65//97 30//97 
                        f 66//98 30//98 34//98 
                        f 67//99 66//99 34//99 
                        f 67//100 34//100 35//100 
                        f 68//101 67//101 35//101 
                        f 68//102 35//102 36//102 
                        f 52//103 68//103 36//103 
                        f 52//104 36//104 40//104 
                        f 54//105 55//105 56//105 
                        f 54//106 56//106 57//106 
                        f 54//107 57//107 58//107 
                        f 54//108 58//108 59//108 
                        f 51//109 53//109 54//109 
                        f 64//110 61//110 62//110 
                        f 64//111 62//111 63//111 
                        f 67//112 52//112 51//112 
                        f 67//113 59//113 60//113 
                        f 67//114 60//114 61//114 
                        f 67//115 64//115 65//115 
                        f 67//116 65//116 66//116 
                        f 67//117 68//117 52//117 
                        f 67//118 54//118 59//118 
                        f 67//119 61//119 64//119 
                        f 67//120 51//120 54//120 
                        f 12//121 20//121 11//121 
                        f 11//122 20//122 38//122 
                        f 38//123 21//123 39//123 
                        f 20//124 21//124 38//124 
                        f 39//125 19//125 41//125 
                        f 41//126 19//126 42//126 
                        f 21//127 19//127 39//127 
                        f 42//128 18//128 44//128 
                        f 19//129 18//129 42//129 
                        f 44//130 17//130 9//130 
                        f 18//131 17//131 44//131 
                        f 17//132 10//132 9//132 
                        `
            const object = new OBJLoader().parse( sourceObject );
            object.traverse( function ( child, index ) {
                if ( child.isMesh ) {
                    const color = Utils.hexToRgb("#646877")
                    child.material.color.r = color.r / 255
                    child.material.color.g = color.g / 255
                    child.material.color.b = color.b / 255
                    child.material.specular.r = 0.2
                    child.material.specular.g = 0.2
                    child.material.specular.b = 0.2
                }

            } );
            object.rotation.x = -Math.PI / 2
            object.rotation.y = 0
            object.rotation.z = 0
            console.log(object)
            scene.add( object );
            console.log("scene")
            console.log(scene)
            this.current3dObject = object
        }
    },
    mounted() {
        // init instanced mesh matrix

        this.coreStore.$onAction((action) => {
            console.log(action)
            if (action.name == "setStreamedObj") {
                var sourceObject = action.args[0]
                this.getPiece(sourceObject)
            }
        })



    },
};
</script>

<template>
  <Renderer ref="renderer" resize=true :orbit-ctrl="{ enableDamping: true, dampingFactor: 0.05, autoRotate : true }" shadow>
    <Camera :position="{ x: 0, y: 20, z: 30 }" />
    <Scene ref="scene" :background="'#1a1a1a'">
      <SpotLight color="#539796" :intensity="1" :position="{ y: 150, z: 100 }" :cast-shadow="true" :shadow-map-size="{ width: 1024, height: 1024 }" />
      <SpotLight color="#539796" :intensity="1" :position="{ y: -150, z: 100 }" :cast-shadow="true" :shadow-map-size="{ width: 1024, height: 1024 }" />
      <SpotLight color="#539796" :intensity="1" :position="{ x: 150, z: 100 }" :cast-shadow="true" :shadow-map-size="{ width: 1024, height: 1024 }" />
      <SpotLight color="#539796" :intensity="1" :position="{ x: -150, z: 100 }" :cast-shadow="true" :shadow-map-size="{ width: 1024, height: 1024 }" />
    </Scene>
  </Renderer>
</template>
